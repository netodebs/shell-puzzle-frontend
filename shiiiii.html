<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Shell Booth Puzzle Challenge</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root{
    --bg-start:#004466;
    --bg-end:#002244;
    --card:#071133;
    --shell-yellow:#FFD700;
    --muted:#98a8be;
    --tile-bg:#1e293b;
    --tile-border:#475569;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(135deg, var(--bg-start), var(--bg-end));
    color:#fff;
    overflow:hidden;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* INTRO OVERLAY (Frosted glass centered) */
  #introOverlay{
    position:fixed;
    inset:0;
    background:rgba(1,6,20,0.80); /* 80% darkness */
    backdrop-filter: blur(8px) saturate(120%);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:100;
    transition:opacity .7s ease, transform .7s ease;
    padding:24px;
  }
  #introOverlay.fade-out{opacity:0;pointer-events:none;transform:scale(.995)}
  .intro-card{
    width:920px;
    max-width:96%;
    background:linear-gradient(180deg, rgba(7,17,51,0.86), rgba(9,32,58,0.86));
    border-radius:12px;
    padding:28px;
    box-shadow:0 20px 80px rgba(2,6,23,0.6);
    text-align:center;
    color:#e6f0ff;
    border:1px solid rgba(255,215,0,0.06);
  }
  .intro-top{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    margin-bottom:8px;
  }
  .shell-logo {
    width:72px;
    height:72px;
    display:inline-block;
    flex:0 0 72px;
    filter: drop-shadow(0 6px 18px rgba(255,215,0,0.12));
  }
  .title {
    font-size:28px;
    font-weight:800;
    color:var(--shell-yellow);
    line-height:1;
  }

  /* Instructions */
  .instructions-wrap{margin-top:8px;margin-bottom:14px}
  .instructions-title{
    color:var(--shell-yellow);
    font-weight:800;
    font-size:18px;
    margin:8px 0;
    text-decoration:underline;
    text-decoration-color:rgba(255,215,0,0.6);
    text-underline-offset:6px;
  }
  .instructions-list{
    text-align:left;
    display:inline-block;
    max-width:760px;
    margin-top:6px;
    color:#eaf5ff;
    font-size:16px;
    line-height:1.6;
  }
  .instructions-list li{margin:8px 0;padding-left:6px}

  /* Input group */
  .input-group{
    margin-top:18px;
    display:flex;
    gap:10px;
    justify-content:center;
  }
  .input-col{
    display:flex;
    flex-direction:column;
    gap:10px;
    min-width:220px;
    max-width:260px;
    width:100%;
  }
  .input-col input{
    background:rgba(7,18,38,0.6);
    border:1px solid rgba(255,255,255,0.04);
    color:#fff;
    padding:12px 14px;
    border-radius:8px;
    font-size:15px;
    text-align:center;
  }
  .start-btn{
    margin-top:16px;
    background:var(--shell-yellow);
    color:#000;
    font-weight:800;
    padding:12px 20px;
    border-radius:10px;
    border:none;
    cursor:pointer;
    font-size:16px;
    transition:transform .14s ease, box-shadow .14s ease;
  }
  .start-btn:hover{transform:translateY(-3px);box-shadow:0 12px 40px rgba(255,215,0,0.16)}

  .intro-footer{
    margin-top:14px;
    color:var(--muted);
    font-size:13px;
  }

  /* GAME LAYOUT */
  .game-container{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    min-height:100vh;
    padding-top:26px;
  }
  .logo-row{
    display:flex;
    align-items:center;
    gap:12px;
    justify-content:center;
    margin-bottom:6px;
  }
  .logo-row .small-logo{
    width:48px;height:48px;flex:0 0 48px;
    filter:drop-shadow(0 8px 18px rgba(255,215,0,0.08));
  }
  .logo-row .heading{
    font-weight:800;
    font-size:20px;
    letter-spacing:0.2px;
  }

  #statusBar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    width:78vmin;
    max-width:920px;
    margin-top:6px;
    font-size:18px;
  }

  #puzzle-grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    grid-template-rows:repeat(3,1fr);
    gap:6px;
    width:78vmin;
    max-width:760px;
    aspect-ratio:1/1;
    border-radius:12px;
    margin-top:12px;
    border:4px solid var(--shell-yellow);
    background:linear-gradient(180deg, rgba(2,6,23,0.5), rgba(3,10,30,0.5));
    overflow:hidden;
  }
  .puzzle-tile{
    position:relative;
    background:var(--tile-bg);
    border:2px solid var(--tile-border);
    background-size:300% 300%;
    transition:transform .12s ease;
    cursor:pointer;
    overflow:hidden;
    border-radius:6px;
  }
  .puzzle-tile:hover:not(.empty){transform:scale(1.02); box-shadow:0 10px 30px rgba(0,0,0,0.45)}
  .puzzle-tile.empty{background:transparent;border:none;cursor:default}
  .tile-number{
    position:absolute;
    bottom:6px;
    right:8px;
    font-size:14px;
    font-weight:800;
    color:var(--shell-yellow);
    text-shadow:0 0 6px rgba(0,0,0,0.6);
    background:rgba(0,0,0,0.22);
    padding:2px 6px;border-radius:6px;
  }

  /* Countdown overlay */
  #countdownWrapper{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);z-index:90}
  .countdown-ring{width:140px;height:140px;border-radius:50%;border:10px solid rgba(255,255,255,0.12);border-top:10px solid var(--shell-yellow);animation:spin 1s linear infinite;display:flex;align-items:center;justify-content:center}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .countdown-text{font-size:2.8rem;color:var(--shell-yellow);font-weight:900}

  /* Message banner */
  #messageBanner{
    position:fixed;
    top:18px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(3,7,18,0.92);
    padding:12px 18px;
    border-radius:8px;
    border:2px solid rgba(255,215,0,0.06);
    display:none;
    z-index:110;
    font-size:16px;
  }

  canvas{position:fixed;inset:0;pointer-events:none;z-index:80}

  @media (max-width:1000px){
    .intro-card{padding:20px}
    .input-group{flex-direction:column;gap:10px}
    .input-col{width:100%}
    #puzzle-grid{width:92vmin}
  }
</style>
</head>
<body>

<!-- Confetti canvas -->
<canvas id="confettiCanvas"></canvas>

<!-- Message Banner -->
<div id="messageBanner" role="status" aria-live="polite"></div>

<!-- INTRO OVERLAY -->
<div id="introOverlay" aria-hidden="false">
  <div class="intro-card" role="dialog" aria-labelledby="introTitle" aria-describedby="introDesc">
    <div class="intro-top">
      <!-- Real Shell favicon URL used here (appears instantly) -->
      <img class="shell-logo" alt="Shell Logo"
        src="https://www.shell.com.ng/etc.clientlibs/amidala/clientlibs/theme-base/resources/favicon/favicon.svg" />
      <div>
        <div id="introTitle" class="title">Shell Booth Puzzle Challenge</div>
      </div>
    </div>

    <div class="instructions-wrap" id="introDesc">
      <div class="instructions-title">Game Instructions</div>
      <ul class="instructions-list">
        <li>Enter your <strong>First Name</strong>, <strong>Last Name</strong>, and <strong>Institution</strong> correctly.</li>
        <li>These details must match your <strong>official ID</strong> before claiming any prize.</li>
        <li>The winner is the player who rearranges the tiles in the <strong>least time (under 120 seconds)</strong>. If times tie, the player with the <strong>fewest moves</strong> wins.</li>
      </ul>
    </div>

    <div class="input-group" role="form" aria-label="Player details">
      <div class="input-col">
        <input id="firstName" type="text" aria-label="First Name" placeholder="First Name" />
        <input id="lastName"  type="text" aria-label="Last Name"  placeholder="Last Name" />
        <input id="institution" type="text" aria-label="Institution" placeholder="Institution" />
        <button id="startGameBtn" class="start-btn" aria-label="Start Puzzle">Start Puzzle</button>
      </div>
    </div>

    <div class="intro-footer">Powered by Shell Nigeria</div>
  </div>
</div>

<!-- GAME -->
<div class="game-container" aria-hidden="false">
  <div class="logo-row" role="banner">
    <img class="small-logo" alt="Shell Logo Small"
      src="https://www.shell.com.ng/etc.clientlibs/amidala/clientlibs/theme-base/resources/favicon/favicon.svg" />
    <div class="heading">Shell Booth Puzzle Challenge</div>
  </div>

  <div id="statusBar" role="status" aria-live="polite">
    <div>‚è± <span id="timer">120</span>s</div>
    <div>üéØ Moves: <span id="moves">0</span></div>
  </div>

  <div id="puzzle-grid" role="application" aria-label="3 by 3 sliding puzzle"></div>

  <!-- Countdown overlay -->
  <div id="countdownWrapper" aria-hidden="true">
    <div class="countdown-ring"><span id="countdownText" class="countdown-text">3</span></div>
  </div>
</div>

<script>
/* ===== Configuration ===== */
const GRID_SIZE = 3;
const TOTAL = GRID_SIZE * GRID_SIZE;
const TIME_LIMIT = 120; // seconds
const IMAGE_URL = "https://www.ripmark.com.ng/wp-content/uploads/2025/09/ship.jpeg.jpeg";
const LOCAL_SCORES_KEY = 'puzzle_scores_v2';
const SERVER_URL = 'https://shell-puzzle-api.onrender.com'; 

/* ===== State ===== */
let tiles = [];
let moves = 0;
let timer = TIME_LIMIT;
let timerInterval = null;
let countdownInterval = null;
let startTime = 0;
let isRunning = false;
let currentPlayer = null;

/* ===== DOM refs ===== */
const puzzleGrid = document.getElementById('puzzle-grid');
const timerEl = document.getElementById('timer');
const movesEl = document.getElementById('moves');
const introOverlay = document.getElementById('introOverlay');
const startBtn = document.getElementById('startGameBtn');
const countdownWrapper = document.getElementById('countdownWrapper');
const countdownText = document.getElementById('countdownText');
const messageBanner = document.getElementById('messageBanner');
const confettiCanvas = document.getElementById('confettiCanvas');
const ctx = confettiCanvas.getContext('2d');

/* ===== Leaderboard helpers (SERVER) ===== */
async function saveScoreAndGetRank(nameId, timeSec, movesCount) {
  const entry = { 
    id: nameId, 
    time: Number(timeSec), 
    moves: Number(movesCount) 
  };
  
  try {
    const response = await fetch(`${SERVER_URL}/score`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(entry)
    });
    if (!response.ok) throw new Error('Server not responding');
    
    const result = await response.json();
    return result.rank; // Server will send back the rank
  } catch (error) {
    console.error('Failed to save score:', error);
    showMessage('üî¥ Error: Could not save score to server.', 3000);
    return -1;
  }
}
/* ===== Confetti (simple) ===== */
let confetti = [];
function ConfettiPiece(x,y,s,c,vx,vy){
  this.x=x;this.y=y;this.s=s;this.c=c;this.vx=vx;this.vy=vy;this.alpha=1;
  this.update=function(){this.vy+=0.2;this.x+=this.vx;this.y+=this.vy;this.alpha-=0.01;};
  this.draw=function(){ctx.globalAlpha=Math.max(this.alpha,0);ctx.fillStyle=this.c;ctx.fillRect(this.x,this.y,this.s,this.s);ctx.globalAlpha=1;};
}
function launchConfetti(){
  confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight;
  for(let i=0;i<60;i++){
    const s = Math.random()*8+4;
    const c = ["#FFD700","#fff","#f00","#0f0","#00f"][Math.floor(Math.random()*5)];
    confetti.push(new ConfettiPiece(innerWidth/2, innerHeight/2, s, c, (Math.random()-0.5)*10, (Math.random()-6)*10));
  }
  (function anim(){
    ctx.clearRect(0,0,innerWidth,innerHeight);
    for(let i=confetti.length-1;i>=0;i--){
      confetti[i].update(); confetti[i].draw();
      if(confetti[i].alpha <= 0) confetti.splice(i,1);
    }
    if(confetti.length>0) requestAnimationFrame(anim);
  })();
}

/* ===== Puzzle logic ===== */
function initTiles(){
  tiles = Array.from({length: TOTAL}, (_, i) => i);
  do { shuffle(tiles); } while(!isSolvable(tiles));
  moves = 0; movesEl.textContent = moves;
  render();
}
function shuffle(arr){
  for(let i=arr.length-2;i>0;i--){
    const j = Math.floor(Math.random()*i);
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}
function isSolvable(arr){
  let inv = 0;
  const flat = arr.filter(t => t !== TOTAL-1);
  for(let i=0;i<flat.length;i++) for(let j=i+1;j<flat.length;j++) if(flat[i] > flat[j]) inv++;
  return inv % 2 === 0;
}
function render(){
  puzzleGrid.innerHTML = '';
  tiles.forEach((val, idx)=>{
    const div = document.createElement('div');
    div.className = 'puzzle-tile';
    if(val === TOTAL-1){ div.classList.add('empty'); }
    else {
      const row = Math.floor(val / GRID_SIZE);
      const col = val % GRID_SIZE;
      const denom = GRID_SIZE - 1;
      const posX = denom === 0 ? 0 : (col / denom) * 100;
      const posY = denom === 0 ? 0 : (row / denom) * 100;
      div.style.backgroundImage = `url('${IMAGE_URL}')`;
      div.style.backgroundPosition = `${posX}% ${posY}%`;
      div.style.backgroundSize = `${GRID_SIZE * 100}% ${GRID_SIZE * 100}%`;
      div.innerHTML = `<span class="tile-number">${val+1}</span>`;
      div.addEventListener('click', ()=>onTileClick(idx));
    }
    puzzleGrid.appendChild(div);
  });
}
function onTileClick(i){
  if(!isRunning) return;
  const emptyIndex = tiles.indexOf(TOTAL-1);
  if(canMove(i, emptyIndex)){
    [tiles[i], tiles[emptyIndex]] = [tiles[emptyIndex], tiles[i]];
    moves++;
    movesEl.textContent = moves;
    render();
    if(checkWin()) handleWin();
  }
}
function canMove(i, emptyIndex){
  const r = Math.floor(i / GRID_SIZE), c = i % GRID_SIZE;
  const er = Math.floor(emptyIndex / GRID_SIZE), ec = emptyIndex % GRID_SIZE;
  return (r === er && Math.abs(c-ec) === 1) || (c === ec && Math.abs(r-er) === 1);
}
function checkWin(){ return tiles.every((v,i) => v === i); }

/* ===== Timer / Countdown ===== */
function startTimer(){
  timer = TIME_LIMIT; timerEl.textContent = timer;
  clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    timer--;
    timerEl.textContent = timer;
    if(timer <= 0){ clearInterval(timerInterval); handleTimeout(); }
  },1000);
}
function stopTimer(){ clearInterval(timerInterval); }

/* ===== Messages and flow ===== */
function showMessage(text, timeout = 2500){
  messageBanner.textContent = text;
  messageBanner.style.display = 'block';
  setTimeout(()=>{ messageBanner.style.display = 'none'; }, timeout);
}

async function handleWin(){
  stopTimer();
  isRunning = false;
  const finalTime = (Date.now() - startTime) / 1000;
  const nameId = `${currentPlayer.first} ${currentPlayer.last} ‚Äî ${currentPlayer.institution}`;
showMessage('Submitting score...', 2000);
  const rank = await saveScoreAndGetRank(nameId, finalTime, moves);
  launchConfetti();
  if(rank > 0){
    showMessage(`üéâ ${currentPlayer.first}! Placed #${rank} ‚Äî recorded on leaderboard.`, 2500);
  } else {
    showMessage(`üéâ ${currentPlayer.first}! Solved in ${finalTime.toFixed(2)}s (${moves} moves). Not in Top 10.`, 2500);
  }
  setTimeout(()=>resetForNextPlayer(), 2600);
}

function handleTimeout(){
  isRunning = false;
  showMessage(`‚è∞ Time's up ‚Äî ${currentPlayer.first} failed to solve the puzzle.`, 2500);
  setTimeout(()=>resetForNextPlayer(), 2600);
}

/* Reset and show overlay again */
function resetForNextPlayer(){
  stopTimer();
  initTiles();
  confetti = [];
  if(!document.body.contains(introOverlay)) document.body.appendChild(introOverlay);
  introOverlay.classList.remove('fade-out');
  document.getElementById('firstName').value = '';
  document.getElementById('lastName').value = '';
  document.getElementById('institution').value = '';
  currentPlayer = null;
  movesEl.textContent = '0';
  timerEl.textContent = TIME_LIMIT;
}

/* Countdown before actual play */
function startCountdown(){
  countdownWrapper.style.display = 'flex';
  countdownText.textContent = '3';
  let c = 3;
  countdownInterval = setInterval(()=>{
    c--;
    if(c > 0) countdownText.textContent = String(c);
    else {
      clearInterval(countdownInterval);
      countdownWrapper.style.display = 'none';
      isRunning = true;
      startTimer();
      startTime = Date.now();
    }
  },1000);
}

/* Start button logic */
startBtn.addEventListener('click', ()=>{
  const fn = document.getElementById('firstName').value.trim();
  const ln = document.getElementById('lastName').value.trim();
  const inst = document.getElementById('institution').value.trim();
  if(!fn || !ln || !inst){ alert('Please fill First Name, Last Name and Institution.'); return; }
  currentPlayer = { first: fn, last: ln, institution: inst };
  // fade overlay out (0.7s)
  introOverlay.classList.add('fade-out');
  setTimeout(()=>{ if(introOverlay && introOverlay.parentNode) introOverlay.parentNode.removeChild(introOverlay); }, 700);
  // start countdown after fade
  setTimeout(()=>startCountdown(), 760);
});

/* Initialization */
window.addEventListener('load', ()=>{
  initTiles();
  confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight;
  timerEl.textContent = TIME_LIMIT;
  movesEl.textContent = 0;
});
window.addEventListener('resize', ()=>{ confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; });
</script>
</body>

</html>
